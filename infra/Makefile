.PHONY: all install build plan apply format validate test clean help

ENV ?= dev
DIR := envs/$(ENV)
TERRAFORM_DIR := $(DIR)/.terraform

all: build

help:
	@echo " ğŸ“¦ install           Initialise Terraform environment"
	@echo " ğŸ”§ build/plan        Generate Terraform execution plan"
	@echo " ğŸ§¹ clean             Remove Terraform state"
	@echo " ğŸš€ apply             Apply infrastructure changes"
	@echo " ğŸ¨ format            Format Terraform code"
	@echo " ğŸ§ª test/validate     Run validation tests"

install:
	@echo "ğŸ“¦ Initialising Terraform for environment: $(ENV)..."
	@cd $(DIR) && terraform init

build:
	@test -d $(TERRAFORM_DIR) || $(MAKE) install
	@echo "ğŸ”§ Generating Terraform plan for environment: $(ENV)..."
	@cd $(DIR) && terraform plan

plan: build

clean:
	@if [ -d $(TERRAFORM_DIR) ]; then \
		echo "ğŸ’£ Destroying Terraform environment: $(ENV)..."; \
		cd $(DIR) && terraform destroy -auto-approve; \
	else \
		echo "âš ï¸ Terraform not initialised. Skipping destroy."; \
	fi
	@echo "ğŸ§¹ Cleaning Terraform state and lockfiles..."
	@find . -name ".terraform" -type d -exec rm -rf {} +
	@find . -name ".terraform.lock.hcl" -delete

apply:
	@test -d $(TERRAFORM_DIR) || $(MAKE) install
	@echo "ğŸš€ Applying Terraform infrastructure for environment: $(ENV)..."
	@cd $(DIR) && terraform apply -auto-approve

validate:
	@test -d $(TERRAFORM_DIR) || $(MAKE) install
	@echo "ğŸ§ª Running Terraform validation tests..."
	@cd $(DIR) && terraform validate

format:
	@echo "ğŸ¨ Formatting Terraform code..."
	@terraform fmt -recursive

test: validate
